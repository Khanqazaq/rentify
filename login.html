<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - Rentify</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        .login-container {
            min-height: calc(100vh - 200px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .login-box {
            max-width: 400px;
            width: 100%;
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .login-title {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }
        .form-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        .divider {
            text-align: center;
            margin: 1.5rem 0;
            color: #6b7280;
        }
        .google-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .google-btn:hover {
            background: #f9fafb;
        }
        /* Location modal / small UI */
        .nav-location {
            margin-left: 16px;
            color: #374151;
            font-weight: 600;
        }
        #location-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); align-items: center; justify-content: center; z-index: 10000;
        }
        #location-box { background:#fff; width:420px; border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,0.25); }
        #location-box input { width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; }
        #location-actions { display:flex; gap:8px; margin-top:12px; }
        
        /* Mobile optimization */
        @media (max-width: 480px) {
            .login-container {
                padding: 1rem;
                min-height: calc(100vh - 100px);
            }
            .login-box {
                padding: 1.5rem;
                border-radius: 16px;
            }
            .login-title {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .form-group {
                margin-bottom: 1rem;
            }
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            .form-group input,
            .google-btn,
            button[type="submit"] {
                padding: 10px;
                font-size: 16px !important;
            }
            .form-options {
                font-size: 0.8rem;
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            #location-box {
                width: 95%;
                max-width: 360px;
                padding: 15px;
            }
            .divider {
                margin: 1rem 0;
                font-size: 0.85rem;
            }
        }

        /* Success Animation Card */
        #success-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .one-div {
            position: relative;
            height: 250px;
            width: 200px;
            background-color: rgb(15, 15, 15);
            transform-style: preserve-3d;
            animation: rot 2s infinite ease;
            border-radius: 20px;
            box-shadow: 0 0 50px 0px, inset 0 0 90px 0px;
            color: white;
            transition: 1.5s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .one-div .text {
            opacity: 0;
            transition: all 0.5s;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .one-div:hover .text {
            scale: 1.2;
            opacity: 0.7;
        }

        .one-div:hover {
            box-shadow: 0 0 30px 1000px black, inset 5px 5px 5px 0px rgb(31, 31, 31);
        }

        @keyframes rot {
            0% {
                transform: rotateX(-15deg) translateY(0px);
            }
            50% {
                transform: rotateX(-15deg) translateY(-10px);
            }
            100% {
                transform: rotateX(-15deg) translateY(0px);
            }
        }

        /* Mobile responsive */
        @media (max-width: 480px) {
            .one-div {
                height: 200px;
                width: 160px;
            }
            .one-div .text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="logo">Rentify</a>
                <div class="nav-menu">
                    <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                </div>
                <div id="nav-location" class="nav-location" title="–í–∞—à –≥–æ—Ä–æ–¥"></div>
            </div>
        </div>
    </nav>

    <div class="login-container">
        <div class="login-box">
            <h2 class="login-title">–í—Ö–æ–¥</h2>

            

            <form id="loginForm">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <select id="countryCode" style="padding:10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff; min-width:80px;">
                            <option value="+7">+7 (KZ)</option>
                        </select>
                        <input id="phoneNumber" type="tel" placeholder="7011234567" maxlength="10" style="flex:1;" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                    </div>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input id="password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">–í–æ–π—Ç–∏</button>
                
                <div class="form-options" style="margin-bottom: 1rem;">
                    <label>
                        <input type="checkbox"> –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è
                    </label>
                    <a href="#" style="color: var(--primary-blue);">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                </div>
                
                <div class="divider">–ò–ª–∏</div>
                <div style="text-align:center; margin-bottom:12px; display:flex; flex-direction:column; gap:8px;">
                    <button type="button" class="google-btn" id="googleLoginBtn">
                        <i class="fab fa-google"></i>
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google
                    </button>
                </div>
                <p style="text-align: center; margin-top: 1rem; color: #6b7280;">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="show-register" style="color: var(--primary-blue); text-decoration: underline; cursor:pointer;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Success Animation -->
    <div id="success-animation">
        <div class="one-div">
            <div class="text">–£—Å–ø–µ—à–Ω–æ! ‚úÖ</div>
        </div>
    </div>

    <!-- Location modal (ask for permission or manual entry) -->
    <div id="location-overlay">
        <div id="location-box">
            <h3 style="margin-top:0; text-align:center;">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º</h3>
            <p id="loc-desc" style="color:#374151;">–°–∞–π—Ç –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à –≥–æ—Ä–æ–¥ –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –†–∞–∑—Ä–µ—à–∏—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.</p>
            <div style="margin-top:8px; display:flex; gap:8px;">
                <button id="loc-allow" style="flex:1; padding:10px; border-radius:8px; background:#10b981; color:#fff; border:none; cursor:pointer;">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
                <button id="loc-manual" style="flex:1; padding:10px; border-radius:8px; background:#f3f4f6; border:none; cursor:pointer;">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</button>
            </div>

            <div id="loc-manual-section" style="display:none; margin-top:12px;">
                <label style="display:block; font-weight:600; margin-bottom:6px;">–ì–æ—Ä–æ–¥ –∏–ª–∏ –∞–¥—Ä–µ—Å</label>
                <input id="loc-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –∞–¥—Ä–µ—Å">
                <div id="location-actions">
                    <button id="loc-save" style="flex:1; padding:10px; border-radius:8px; background:#4f46e5; color:#fff; border:none; cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button id="loc-cancel" style="padding:10px; border-radius:8px; background:#f3f4f6; border:none; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Registration modal / section (hidden by default) -->
        <div id="register-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999;">
            <div style="background:#fff; width:90%; max-width:420px; border-radius:12px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); max-height:90vh; overflow-y:auto;">
                <h2 style="margin-top:0; text-align:center;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div style="margin-bottom:10px;">
                    <label style="display:block; font-weight:600; margin-bottom:6px;">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <select id="regCountryCode" style="padding:10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff; min-width:80px;">
                            <option value="+7">+7 (KZ)</option>
                        </select>
                        <input id="regPhone" type="tel" placeholder="7011234567" maxlength="10" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e5e7eb;" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                    </div>
                </div>

                <div id="reg-actions" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button id="send-code-btn" style="flex:1; padding:10px; border-radius:8px; background:#4f46e5; color:#fff; border:none; cursor:pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
                    <button id="close-register" style="padding:10px; border-radius:8px; background:#f3f4f6; border:none; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
                </div>

                <div id="code-section" style="display:none; margin-bottom:8px;">
                    <label style="display:block; font-weight:600; margin-bottom:6px;">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
                    <input id="regCode" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" maxlength="6" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb;">
                    <small id="code-info" style="display:block; color:#6b7280; margin-top:6px;">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç.</small>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <input id="regPassword" type="password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" style="flex:1; padding:10px; border-radius:8px; border:1px solid #e5e7eb;">
                        <button id="verify-code-btn" style="padding:10px; border-radius:8px; background:#06b6d4; color:#fff; border:none; cursor:pointer;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </div>
                    <div style="margin-top:8px; color:#6b7280;"><span id="resend-timer"></span></div>
                </div>
            </div>
        </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Rentify. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>

    <script src="js/language.js"></script>
    <script>
        // –ü—Ä–æ—Å—Ç–∞—è –∏ —Ä–∞–±–æ—á–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', function(){
            console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

            // === –í–•–û–î ===
            const loginForm = document.getElementById('loginForm');
            const googleBtn = document.getElementById('googleLoginBtn');

            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞...');

                    const phoneInput = document.getElementById('phoneNumber').value.replace(/\D/g,'');
                    const password = document.getElementById('password').value;

                    if (!/^\d{10}$/.test(phoneInput)) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 10-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                        return;
                    }

                    if (!password) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                        return;
                    }

                    const fullPhone = '+7' + phoneInput;
                    console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º:', fullPhone);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ localStorage
                    const usersRaw = localStorage.getItem('users');
                    const users = usersRaw ? JSON.parse(usersRaw) : [];
                    const user = users.find(u => u.id === fullPhone && u.password === password);

                    // –î–µ–º–æ –∞–∫–∫–∞—É–Ω—Ç—ã
                    const isDemo = (fullPhone === '+77001234567' || fullPhone === '+77001234568') && password === '1234';

                    if (user || isDemo) {
                        alert('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                        localStorage.setItem('currentUser', fullPhone);
                        window.location.href = 'index.html';
                    } else {
                        alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                    }
                });
            }

            if (googleBtn) {
                googleBtn.addEventListener('click', function() {
                    alert('Google –≤—Ö–æ–¥ (–î–ï–ú–û)');
                    window.location.href = 'index.html';
                });
            }

            // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
            const showRegisterBtn = document.getElementById('show-register');
            const registerOverlay = document.getElementById('register-overlay');
            const closeRegisterBtn = document.getElementById('close-register');
            const sendCodeBtn = document.getElementById('send-code-btn');
            const verifyCodeBtn = document.getElementById('verify-code-btn');
            const codeSection = document.getElementById('code-section');

            console.log('–ö–Ω–æ–ø–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', {
                showRegisterBtn: !!showRegisterBtn,
                registerOverlay: !!registerOverlay,
                sendCodeBtn: !!sendCodeBtn
            });

            let currentCode = null;
            let currentPhone = null;

            // –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            if (showRegisterBtn && registerOverlay) {
                showRegisterBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
                    registerOverlay.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }

            // –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
            if (closeRegisterBtn && registerOverlay) {
                closeRegisterBtn.addEventListener('click', function() {
                    registerOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                });

                registerOverlay.addEventListener('click', function(e) {
                    if (e.target === registerOverlay) {
                        registerOverlay.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            }

            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
            if (sendCodeBtn) {
                sendCodeBtn.addEventListener('click', function() {
                    const phoneInput = document.getElementById('regPhone').value.replace(/\D/g,'');

                    if (!/^\d{10}$/.test(phoneInput)) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 10-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä');
                        return;
                    }

                    currentPhone = '+7' + phoneInput;
                    currentCode = String(Math.floor(100000 + Math.random() * 900000));

                    alert('üì± –í–∞—à –∫–æ–¥: ' + currentCode);
                    console.log('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', currentCode);

                    codeSection.style.display = 'block';
                });
            }

            // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥ –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
            if (verifyCodeBtn) {
                verifyCodeBtn.addEventListener('click', function() {
                    const enteredCode = document.getElementById('regCode').value.trim();
                    const password = document.getElementById('regPassword').value.trim();

                    if (!enteredCode) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
                        return;
                    }

                    if (!password || password.length < 4) {
                        alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
                        return;
                    }

                    if (enteredCode !== currentCode) {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                        return;
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const usersRaw = localStorage.getItem('users');
                    const users = usersRaw ? JSON.parse(usersRaw) : [];

                    const exists = users.find(u => u.id === currentPhone);
                    if (exists) {
                        alert('–≠—Ç–æ—Ç –Ω–æ–º–µ—Ä —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                        return;
                    }

                    users.push({
                        id: currentPhone,
                        password: password,
                        created: Date.now()
                    });

                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // Show success animation
                    const successAnimation = document.getElementById('success-animation');
                    successAnimation.style.display = 'flex';
                    
                    // Hide after 3 seconds and close modal
                    setTimeout(() => {
                        successAnimation.style.display = 'none';
                        registerOverlay.style.display = 'none';
                        document.body.style.overflow = '';
                        codeSection.style.display = 'none';
                        document.getElementById('regCode').value = '';
                        document.getElementById('regPassword').value = '';
                        document.getElementById('regPhone').value = '';
                    }, 3000);
                });
            }

            console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
        });

        // Location prompt
        (function(){
                    const overlay = document.getElementById('location-overlay');
                    const btnAllow = document.getElementById('loc-allow');
                    const btnManual = document.getElementById('loc-manual');
                    const manualSection = document.getElementById('loc-manual-section');
                    const locInput = document.getElementById('loc-input');
                    const locSave = document.getElementById('loc-save');
                    const locCancel = document.getElementById('loc-cancel');
                    const navLocation = document.getElementById('nav-location');

                    function showOverlay(){
                        // If we already have saved location, don't show by default
                        try{
                            const saved = localStorage.getItem('user_location');
                            if(saved){ const s = JSON.parse(saved); if(s && s.city) { navLocation.textContent = s.city; return; } }
                        }catch(e){}
                        overlay.style.display = 'flex';
                    }

                    function hideOverlay(){ overlay.style.display = 'none'; manualSection.style.display = 'none'; }

                    function saveLocation(obj){
                        localStorage.setItem('user_location', JSON.stringify(obj));
                        if(obj.city) navLocation.textContent = obj.city;
                        else if(obj.address) navLocation.textContent = obj.address;
                    }

                    async function reverseGeocode(lat, lon){
                        try{
                            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=ru`;
                            const res = await fetch(url);
                            if(!res.ok) throw new Error('Reverse geocode failed');
                            const data = await res.json();
                            // Try to extract city / town / village / county
                            const addr = data.address || {};
                            const city = addr.city || addr.town || addr.village || addr.county || addr.state || null;
                            const display = data.display_name || '';
                            return { city, address: display, lat, lon };
                        }catch(err){ return null; }
                    }

                    btnAllow && btnAllow.addEventListener('click', ()=>{
                        if(!navigator.geolocation){ alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
                        btnAllow.disabled = true; btnAllow.textContent = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º...';
                        navigator.geolocation.getCurrentPosition(async (pos)=>{
                            const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                            const info = await reverseGeocode(lat, lon);
                            if(info){ saveLocation(info); alert('–û–ø—Ä–µ–¥–µ–ª–µ–Ω –≥–æ—Ä–æ–¥: ' + (info.city || info.address)); }
                            else { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'); }
                            hideOverlay();
                        }, (err)=>{
                            btnAllow.disabled = false; btnAllow.textContent = '–†–∞–∑—Ä–µ—à–∏—Ç—å';
                            if(err.code === 1) { /* permission denied */ alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.'); manualSection.style.display='block'; }
                            else alert('–û—à–∏–±–∫–∞: ' + (err.message||err.code));
                        }, { enableHighAccuracy: false, timeout: 10000 });
                    });

                    btnManual && btnManual.addEventListener('click', ()=>{ manualSection.style.display = 'block'; });
                    locCancel && locCancel.addEventListener('click', ()=>{ manualSection.style.display='none'; overlay.style.display='none'; });
                    locSave && locSave.addEventListener('click', ()=>{
                        const v = (locInput.value||'').trim();
                        if(!v){ alert('–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥'); locInput.focus(); return; }
                        saveLocation({ city: v, address: v });
                        hideOverlay();
                    });

                    // Show overlay on first visit (or when no saved location)
                    try{
                        const saved = localStorage.getItem('user_location');
                        if(saved){ const s = JSON.parse(saved); if(s && (s.city||s.address)) { if(navLocation) navLocation.textContent = s.city||s.address; return; } }
                    }catch(e){}
                    // small delay to avoid popping immediately
                    setTimeout(showOverlay, 800);
                })();
    </script>
    
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-db.js"></script>
    <script src="js/notifications.js"></script>
</body>
</html>

